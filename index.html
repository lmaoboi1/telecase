<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рулетка Смайликів</title>
    <!-- Підключення Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Підключення Leaflet.js (для інтерактивної карти) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Підключення шрифту Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Встановлюємо шрифт Inter за замовчуванням */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Стиль для центрального маркера */
        #roulette-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 5px; /* Ширина маркера */
            height: 100%;
            background-color: rgba(239, 68, 68, 0.9); /* Червоний колір */
            box-shadow: 0 0 15px rgba(239, 68, 68, 1); /* Тінь для світіння */
            z-index: 10;
            border-radius: 2px;
        }

        /* Стиль для картки, яка виграла */
        .roulette-card.winner {
            transform: scale(1.15); /* Трохи збільшуємо */
            box-shadow: 0 0 25px #ffffff, 0 0 10px #ffffff; /* Яскрава біла тінь */
            z-index: 5;
        }
        
        /* Класи для рідкісності смайликів */
        .rarity-common { border-color: #6b7280; } /* gray-500 */
        .rarity-uncommon { border-color: #3b82f6; } /* blue-500 */
        .rarity-rare { border-color: #a855f7; } /* purple-500 */
        .rarity-legendary { border-color: #f59e0b; } /* amber-500 */
        
        /* Відступи для центрування */
        #roulette-strip {
            padding-left: calc(50% - 50px); 
            padding-right: calc(50% - 50px);
        }

        /* Стилі для модальних вікон */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }

        /* Стилі для анімації галочки */
        .checkmark-svg {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: block;
            stroke-width: 3;
            stroke: #4ade80; /* green-400 */
            stroke-miterlimit: 10;
            margin: 20px auto;
            box-shadow: inset 0px 0px 0px #4ade80;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .checkmark-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 3;
            stroke-miterlimit: 10;
            stroke: #4ade80;
            fill: none;
            animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .checkmark-check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards;
        }
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
        @keyframes scale {
            0%, 100% { transform: none; }
            50% { transform: scale3d(1.1, 1.1, 1); }
        }
        @keyframes fill {
            100% { box-shadow: inset 0px 0px 0px 50px #4ade80; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen overflow-hidden p-4">

    <main class="container mx-auto p-6 md:p-8 text-center w-full">
        <h1 class="text-4xl md:text-5xl font-bold mb-6 text-indigo-300">Рулетка Телефонів</h1>
        <p class="text-lg text-gray-400 mb-8">Натисніть кнопку, щоб спробувати удачу!</p>

        <!-- Контейнер рулетки -->
        <div id="roulette-container" class="relative w-full max-w-5xl mx-auto overflow-hidden bg-gray-800 rounded-xl shadow-2xl py-8 select-none border-2 border-gray-700">
            <!-- Стрічка зі смайликами -->
            <div id="roulette-strip" class="flex">
                <!-- Картки генеруються JS -->
            </div>
        </div>

        <!-- Кнопка "Крутити" -->
        <button id="spin-button" class="mt-10 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
            Крутити!
        </button>

    </main>

    <!-- Модальне вікно переможця з формою -->
    <div id="winner-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white text-gray-900 rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-2xl transform transition-all scale-95 opacity-0 my-8" style="transition: transform 0.3s ease, opacity 0.3s ease;">
            <h2 class="text-2xl md:text-3xl font-bold text-center mb-4">Вітаємо! Ви виграли:</h2>
            
            <div id="winner-product-display" class="text-center mb-6">
                <img id="winner-image" src="" alt="Виграний приз" class="w-48 h-48 md:w-64 md:h-64 object-contain mx-auto mb-4 rounded-lg">
                <p id="winner-name" class="text-xl md:text-2xl font-semibold text-gray-800"></p>
            </div>
            
            <form id="winner-form">
                <p class="text-lg text-gray-700 mb-4">Будь ласка, заповніть форму, щоб отримати приз:</p>
                
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Ім'я:</label>
                    <input type="text" id="name" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                    <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Адреса:</label>
                    <p class="text-xs text-gray-500 mb-2">Клікніть на карту, щоб вказати вашу адресу.</p>
                    <!-- Контейнер для карти -->
                    <div id="map" class="h-64 w-full rounded-lg border border-gray-300 z-10"></div>
                </div>

                <div id="form-error" class="text-red-600 text-sm mb-4 hidden">
                    <!-- Повідомлення про помилки сюди -->
                </div>

                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                    Підтвердити
                </button>
            </form>
        </div>
    </div>

    <!-- Модальне вікно успіху -->
    <div id="success-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-white text-gray-900 rounded-2xl shadow-xl p-8 md:p-12 w-full max-w-md text-center transform transition-all scale-95 opacity-0" style="transition: transform 0.3s ease, opacity 0.3s ease;">
            <!-- Анімована галочка SVG -->
            <svg class="checkmark-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
            
            <h2 class="text-3xl font-bold text-center mt-4 mb-3 text-gray-800">Успіх!</h2>
            <p class="text-lg text-gray-600 mb-6">Ваші дані успішно відправлено. Ми скоро з вами зв'яжемось!</p>
            
            <button id="close-success-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-all duration-300">
                Закрити
            </button>
        </div>
    </div>


    <script>
        // --- Налаштування Рулетки ---

        // Список телефонів (з вашого HTML)
        const productList = [
            { name: 'iPhone 17 Pro Max, 256 ГБ, Cosmic Orange', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/2d/22/2d22e5e521d6491cf0dd8c0c8a47f2eb/250915140013863146.webp', rarity: 'legendary' },
            { name: 'iPhone 17 Pro, 256 ГБ, Deep Blue', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/be/d2/bed2ebac62b52c2580a68b9e0d67d995/250915140029572558.webp', rarity: 'rare' },
            { name: 'iPhone 17 Pro Max, 2 TB, Deep Blue', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/41/49/4149198f1713e718ba920b85acffb4f4/250915140038367093.webp', rarity: 'legendary' },
            { name: 'iPhone 17 Pro Max, 2 TB, Silver', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/a3/44/a34423b7b08300fde0625964a0130f66/250915140035204152.webp', rarity: 'legendary' },
            { name: 'iPhone 17 Pro, 1 TB, Silver', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/a9/6c/a96c19277c05e15cfeeacee84a370ba0/250915140025661602.webp', rarity: 'rare' },
            { name: 'iPhone 17 Pro, 1 TB, Cosmic Orange', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/8a/8a/8a8ae008f8b519511bfc41e8d16b6f81/250915140023667226.webp', rarity: 'rare' },
            { name: 'iPhone 17 Pro, 512 ГБ, Silver', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/a9/6c/a96c19277c05e15cfeeacee84a370ba0/250915140025661602.webp', rarity: 'uncommon' },
            { name: 'iPhone 17 Pro, 256 ГБ, Silver', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/a9/6c/a96c19277c05e15cfeeacee84a370ba0/250915140025661602.webp', rarity: 'common' },
            { name: 'iPhone 17 Pro, 256 ГБ, Cosmic Orange', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/8a/8a/8a8ae008f8b519511bfc41e8d16b6f81/250915140023667226.webp', rarity: 'common' },
            { name: 'iPhone 17 Pro Max, 512 ГБ, Deep Blue', image: 'https://cdn0.it4profit.com/s3size/el:t/rt:fill/w:512/plain/s3://cms/product/41/49/4149198f1713e718ba920b85acffb4f4/250915140038367093.webp', rarity: 'uncommon' }
        ];

        // Карта класів для рідкісності
        const rarityClasses = {
            common: 'rarity-common',
            uncommon: 'rarity-uncommon',
            rare: 'rarity-rare',
            legendary: 'rarity-legendary',
        };

        // DOM Елементи
        const strip = document.getElementById('roulette-strip');
        const spinButton = document.getElementById('spin-button');
        const winnerModal = document.getElementById('winner-modal');
        const winnerImage = document.getElementById('winner-image');
        const winnerName = document.getElementById('winner-name');
        const winnerForm = document.getElementById('winner-form');
        const formError = document.getElementById('form-error');
        const successModal = document.getElementById('success-modal');
        const closeSuccessBtn = document.getElementById('close-success-btn');
        const mapContainer = document.getElementById('map');

        // Змінні стану
        let fullRouletteList = []; 
        let isSpinning = false; 
        const cardWidthWithMargin = 104; // w-24 (96px) + mx-1 (8px) = 104px
        
        // Змінні для карти
        let map;
        let marker;

        // --- Функції ---

        /**
         * Перемішує масив (алгоритм Фішера-Єйтса)
         */
        function shuffle(array) {
            let currentIndex = array.length,  randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        /**
         * Заповнює стрічку рулетки смайликами
         */
        function populateRoulette() {
            strip.innerHTML = ''; 
            fullRouletteList = []; 
            
            // Створюємо довгу стрічку, повторюючи та перемішуючи список 15 разів
            for (let i = 0; i < 15; i++) {
                const shuffledProducts = shuffle([...productList]);
                fullRouletteList.push(...shuffledProducts);
            }

            // Створюємо DOM-елементи для кожного телефона
            fullRouletteList.forEach(item => {
                const card = document.createElement('div');
                card.className = `roulette-card w-24 h-24 mx-1 flex-shrink-0 flex items-center justify-center bg-gray-700 rounded-md border-4 ${rarityClasses[item.rarity]} transition-all duration-300 p-1 overflow-hidden`;
                
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.name.substring(0, 20); // Короткий alt
                img.className = 'w-full h-full object-contain rounded-sm';
                
                card.appendChild(img);
                strip.appendChild(card);
            });
        }

        /**
         * Ініціалізує або оновлює карту
         */
        function initMap() {
            if (!map) {
                // Встановлюємо початковий вигляд на Київ
                map = L.map('map').setView([50.4501, 30.5234], 10);
                
                // Додаємо шар тайлів OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Обробник кліку на карті для розміщення/переміщення маркера
                map.on('click', function(e) {
                    if (marker) {
                        marker.setLatLng(e.latlng);
                    } else {
                        marker = L.marker(e.latlng).addTo(map);
                    }
                    formError.classList.add('hidden'); // Ховаємо помилку, якщо вона була
                });
            } else {
                // Якщо карта вже існує, просто скидаємо вигляд і маркер
                map.setView([50.4501, 30.5234], 10);
                if (marker) {
                    marker.remove();
                    marker = null;
                }
            }
            
            // Важливо: оновлюємо розмір карти після того, як модальне вікно стало видимим
            // Використовуємо невелику затримку, щоб CSS-перехід встиг початися
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }

        /**
         * Показує модальне вікно переможця
         */
        function showWinnerModal(winner) {
            winnerImage.src = winner.image;
            winnerImage.alt = winner.name;
            winnerName.textContent = winner.name;
            
            const modalContent = winnerModal.querySelector('.bg-white');
            
            winnerModal.classList.remove('hidden');
            setTimeout(() => {
                winnerModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10); // Невелика затримка для плавного CSS-переходу

            // Ініціалізуємо карту
            initMap();
        }

        /**
         * Ховає модальне вікно переможця
         */
        function hideWinnerModal() {
            const modalContent = winnerModal.querySelector('.bg-white');
            
            winnerModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95', 'opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                winnerModal.classList.add('hidden');
                winnerForm.reset(); // Скидаємо форму
                if (marker) {
                    marker.remove();
                    marker = null;
                }
                formError.classList.add('hidden');
            }, 300); // Час = тривалість transition
        }

        /**
         * Показує модальне вікно успіху
         */
        function showSuccessModal() {
            const modalContent = successModal.querySelector('.bg-white');
            
            successModal.classList.remove('hidden');
            setTimeout(() => {
                successModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        /**
         * Ховає модальне вікно успіху
         */
        function hideSuccessModal() {
            const modalContent = successModal.querySelector('.bg-white');

            successModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95', 'opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                successModal.classList.add('hidden');
            }, 300);
        }

        /**
         * Запускає анімацію прокрутки
         */
        function spin() {
            if (isSpinning) return;
            isSpinning = true;
            spinButton.disabled = true;

            document.querySelector('.winner')?.classList.remove('winner');
            const container = document.getElementById('roulette-container');
            const containerCenter = container.offsetWidth / 2;

            // 1. Скидаємо анімацію та позицію
            // Встановлюємо випадкову початкову позицію для "стрибка"
            const randomStartIndex = Math.floor(Math.random() * 30) + 20; // з 20 по 50
            const randomStartCard = strip.children[randomStartIndex];
            const startTranslateX = containerCenter - (randomStartCard.offsetLeft + cardWidthWithMargin / 2);

            strip.style.transition = 'none';
            strip.style.transform = `translateX(${startTranslateX}px)`;
            
            // Примусове перемалювання, щоб браузер застосував скидання
            strip.offsetHeight; 

            // 2. Вибираємо картку-переможця (подалі від країв)
            const minIndex = 60;
            const maxIndex = fullRouletteList.length - 20;
            const winningCardIndex = Math.floor(Math.random() * (maxIndex - minIndex)) + minIndex;
            const winningCardElement = strip.children[winningCardIndex];
            const winner = fullRouletteList[winningCardIndex];

            // 3. Розраховуємо кінцеву позицію
            const cardCenter = winningCardElement.offsetLeft + cardWidthWithMargin / 2;
            const jitter = (Math.random() - 0.5) * (cardWidthWithMargin * 0.7);
            const finalTranslateX = containerCenter - cardCenter + jitter;
            
            // 4. Запускаємо плавну анімацію
            const spinDuration = 6000; // 6 секунд
            strip.style.transition = `transform ${spinDuration}ms cubic-bezier(0.1, 0.7, 0.3, 1)`;
            strip.style.transform = `translateX(${finalTranslateX}px)`;

            // 5. Обробляємо завершення анімації
            setTimeout(() => {
                isSpinning = false;
                spinButton.disabled = false;
                
                winningCardElement.classList.add('winner');
                
                // Показуємо модальне вікно з формою
                showWinnerModal(winner);

            }, spinDuration);
        }

        // --- Ініціалізація та Обробники Подій ---

        // Заповнюємо рулетку при завантаженні сторінки
        document.addEventListener('DOMContentLoaded', () => {
            populateRoulette();
            spinButton.addEventListener('click', spin);

            // Обробник відправки форми
            winnerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                // Перевіряємо, чи встановлено маркер на карті
                if (!marker) {
                    formError.textContent = 'Будь ласка, вкажіть вашу адресу на карті.';
                    formError.classList.remove('hidden');
                    return;
                }

                // Якщо все добре
                formError.classList.add('hidden');
                
                // Тут ви б відправили дані на сервер, наприклад:
                const formData = new FormData(winnerForm);
                const data = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    address: marker.getLatLng()
                };
                console.log('Дані форми:', data);

                // Ховаємо вікно з формою і показуємо вікно успіху
                hideWinnerModal();
                showSuccessModal();
            });

            // Обробник кнопки "Закрити" на вікні успіху
            closeSuccessBtn.addEventListener('click', () => {
                hideSuccessModal();
            });
        });

    </script>
</body>
</html>
